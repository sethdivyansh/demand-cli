<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Template WebSocket Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        display: grid;
        gap: 20px;
      }
      .section {
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
      }
      .log {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      input,
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 3px;
        margin: 5px 0;
      }
      textarea {
        height: 100px;
        font-family: monospace;
      }
      .status {
        padding: 10px;
        border-radius: 3px;
        margin: 10px 0;
      }
      .status.connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <h1>Template WebSocket Test</h1>

    <div class="container">
      <div class="section">
        <h3>WebSocket Connection</h3>
        <div id="connectionStatus" class="status disconnected">
          Disconnected
        </div>
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>
          Disconnect
        </button>
      </div>

      <div class="section">
        <h3>Submit Transaction List</h3>
        <label for="templateId">Template ID:</label>
        <input
          type="number"
          id="templateId"
          placeholder="Enter template ID"
          value="1"
        />

        <label for="txids">Transaction IDs (one per line):</label>
        <textarea id="txids" placeholder="Enter transaction IDs, one per line">
49f9493713bdd0eb7b2537362cd740c4591637e299437b1b53baddf68e93068b
281945f21d1b11a134228beb4f5a8b2e9fc09710ca84791c4b44ab0592bc42ed
7d1c37f9f6812aa29870abff2e637c65945a0a28f67422411c917f458e72d015</textarea
        >

        <button onclick="submitTransactions()">Submit Transaction List</button>
      </div>

      <div class="section">
        <h3>Messages Log</h3>
        <div id="messagesLog" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
      </div>
    </div>

    <script>
      let ws = null;
      let wsUrl = "ws://localhost:3001/ws/template/stream";

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById("messagesLog");
        const messageElement = document.createElement("div");
        messageElement.style.color =
          type === "error" ? "red" : type === "success" ? "green" : "black";
        messageElement.textContent = `[${timestamp}] ${message}`;
        logElement.appendChild(messageElement);
        logElement.scrollTop = logElement.scrollHeight;
      }

      function updateConnectionStatus(connected) {
        const statusElement = document.getElementById("connectionStatus");
        const connectBtn = document.getElementById("connectBtn");
        const disconnectBtn = document.getElementById("disconnectBtn");

        if (connected) {
          statusElement.textContent = "Connected";
          statusElement.className = "status connected";
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
        } else {
          statusElement.textContent = "Disconnected";
          statusElement.className = "status disconnected";
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
        }
      }

      function connect() {
        try {
          ws = new WebSocket(wsUrl);

          ws.onopen = function (event) {
            log("WebSocket connected successfully", "success");
            updateConnectionStatus(true);
          };

          ws.onmessage = function (event) {
            try {
              const data = JSON.parse(event.data);
              log(`Received: ${JSON.stringify(data, null, 2)}`, "info");

              if (data.event === "new_template") {
                log(
                  `üîî New Template Received! ID: ${data.template_id}`,
                  "success"
                );
              } else if (data.success !== undefined) {
                if (data.success) {
                  log(`‚úÖ Job Declaration Success: ${data.message}`, "success");
                  if (data.data) {
                    log(`   - Request ID: ${data.data.req_id}`, "info");
                    log(`   - Job ID: ${data.data.job_id}`, "info");
                    log(`   - Channel ID: ${data.data.channel_id}`, "info");
                    log(
                      `   - Mining Job Token: ${data.data.mining_job_token}`,
                      "info"
                    );
                    if (
                      data.data.rejected_tx &&
                      data.data.rejected_tx.length > 0
                    ) {
                      log(
                        `   - Rejected TXs: ${data.data.rejected_tx.join(
                          ", "
                        )}`,
                        "info"
                      );
                    }
                  }
                } else {
                  log(`‚ùå Job Declaration Failed: ${data.message}`, "error");
                }
              }
            } catch (e) {
              log(`Raw message: ${event.data}`, "info");
            }
          };

          ws.onclose = function (event) {
            log(
              `WebSocket closed. Code: ${event.code}, Reason: ${event.reason}`,
              "error"
            );
            updateConnectionStatus(false);
            ws = null;
          };

          ws.onerror = function (error) {
            log(`WebSocket error: ${error}`, "error");
            updateConnectionStatus(false);
          };
        } catch (error) {
          log(`Failed to connect: ${error}`, "error");
        }
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
        }
      }

      async function submitTransactions() {
        const templateId = parseInt(
          document.getElementById("templateId").value
        );
        const txidsText = document.getElementById("txids").value.trim();

        if (!templateId || !txidsText) {
          alert("Please enter both template ID and transaction IDs");
          return;
        }

        const txids = txidsText
          .split("\n")
          .map((tx) => tx.trim())
          .filter((tx) => tx.length > 0);

        if (txids.length === 0) {
          alert("Please enter at least one transaction ID");
          return;
        }

        const payload = {
          template_id: templateId,
          txids: txids,
        };

        try {
          log(
            `Submitting transaction list for template ${templateId} with ${txids.length} transactions...`,
            "info"
          );

          const response = await fetch("/api/job-declaration", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const result = await response.json();

          if (response.ok) {
            log(`‚úÖ Transaction list submitted successfully`, "success");
            if (
              result.data &&
              result.data["invalid_txids"] &&
              result.data["invalid_txids"].length > 0
            ) {
              log(
                `‚ö†Ô∏è  Some transactions were invalid: ${JSON.stringify(
                  result.data["invalid_txids"]
                )}`,
                "error"
              );
            }
          } else {
            log(
              `‚ùå Failed to submit transaction list: ${
                result.message || "Unknown error"
              }`,
              "error"
            );
          }
        } catch (error) {
          log(`‚ùå Error submitting transaction list: ${error}`, "error");
        }
      }

      function clearLog() {
        document.getElementById("messagesLog").innerHTML = "";
      }

      // Auto-connect on page load
      window.onload = function () {
        log(
          "Page loaded. Click Connect to start WebSocket connection.",
          "info"
        );
      };
    </script>
  </body>
</html>
